<template>
  <div class="flex flex-col p-4 bg-white border rounded-lg shadow-sm h-full">
    <h2 class="text-xl font-bold mb-4">악성 업로드 Top 5 사용자</h2>
    <div class="flex-grow relative">
      <canvas ref="myChart" class="absolute inset-0"></canvas>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { Chart, BarController, BarElement, CategoryScale, LinearScale, Tooltip, Legend } from 'chart.js';

Chart.register(BarController, BarElement, CategoryScale, LinearScale, Tooltip, Legend);

const props = defineProps({
  topMalwareUser: Object,
  required: true
});

const myChart = ref(null);

const data = {
  labels: props.topMalwareUser.map(row => row.user),
  datasets: [{
    data: props.topMalwareUser.map(row => row.malware),
    backgroundColor: [
      'rgb(153 27 27)',
      'rgb(185 28 28)',
      'rgb(220 38 38)',
      'rgb(239 68 68)',
      'rgb(248 113 113)',
    ],
    categoryPercentage: 0.5,
    barPercentage: 0.5,
    barThickness: 20,
    maxBarThickness: 20
  }]
};

const config = {
  type: 'bar',
  data: data,
  options: {
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: false,
      },
    },
    scales: {
      x: {
        beginAtZero: true,
        ticks: {
          stepSize: function(context) {
            const max = context.chart.scales.x.max;
            if (max <= 10) return 1;
            if (max <= 100) return 10;
            if (max <= 1000) return 100;
            return Math.pow(10, Math.floor(Math.log10(max) - 1));
          },
          callback: function(value) {
            return value + ' 개';
          }
        }
      },
      y: {
        grid: {
          display: false
        },
      }
    }
  },
};

onMounted(() => {
  const ctx = myChart.value.getContext('2d');
  new Chart(ctx, config);
});
</script>